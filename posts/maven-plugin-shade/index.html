<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>maven-plugin-shade：介绍与使用｜六开箱</title><meta name=keywords content="Java,Maven,插件,介绍,使用,教程"><meta name=description content="使用 maven-plugin-shade 打包你的项目依赖，生成完整的可运行 jar 包。"><meta name=author content="六开箱"><link rel=canonical href=https://lkxed.github.io/posts/maven-plugin-shade/><link crossorigin=anonymous href=/assets/css/stylesheet.min.09b98575a0a9c52a0dcff6660328188f9365049be8c47253f3072a85d10d82a5.css integrity="sha256-CbmFdaCpxSoNz/ZmAygYj5NlBJvoxHJT8wcqhdENgqU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://lkxed.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lkxed.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lkxed.github.io/favicon-32x32.png><link rel=manifest href=https://lkxed.github.io/site.webmanifest><link rel=apple-touch-icon href=https://lkxed.github.io/apple-touch-icon.png><link rel=mask-icon href=https://lkxed.github.io/safari-pinned-tab.svg><meta name=theme-color content="#f5f5f5" media="(prefers-color-scheme: light)"><meta name=theme-color content="#1d1e20" media="(prefers-color-scheme: dark)"><meta name=msapplication-TileColor content="#ffffff"><noscript><style>.top-link{display:none}</style></noscript><meta name=shenma-site-verification content="0834e815906a93375245a759f409f8b0_1648880760"><meta name=baidu-site-verification content="code-2I1Hg4GETM"><meta name=google-site-verification content="QWaJU9oM7UFAshQEDkcyAZivnI9b6iIOR59kso4I_QE"><meta property="og:title" content="maven-plugin-shade：介绍与使用"><meta property="og:description" content="使用 maven-plugin-shade 打包你的项目依赖，生成完整的可运行 jar 包。"><meta property="og:type" content="article"><meta property="og:url" content="https://lkxed.github.io/posts/maven-plugin-shade/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-25T16:43:24+08:00"><meta property="article:modified_time" content="2021-03-25T16:43:24+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="maven-plugin-shade：介绍与使用"><meta name=twitter:description content="使用 maven-plugin-shade 打包你的项目依赖，生成完整的可运行 jar 包。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章","item":"https://lkxed.github.io/posts/"},{"@type":"ListItem","position":2,"name":"maven-plugin-shade：介绍与使用","item":"https://lkxed.github.io/posts/maven-plugin-shade/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"maven-plugin-shade：介绍与使用","name":"maven-plugin-shade：介绍与使用","description":"使用 maven-plugin-shade 打包你的项目依赖，生成完整的可运行 jar 包。","keywords":["Java","Maven","插件","介绍","使用","教程"],"articleBody":" 使用 maven-plugin-shade 打包你的项目依赖，生成完整的可运行 jar 包。\n 介绍 maven-plugin-shade 插件提供了两个能力：\n 把整个项目（包含它的依赖）都打包到一个 “uber-jar” 中 shade - 即重命名某些依赖的包  由此引出了两个问题：\n  什么是 uber-jar ？\nuber-jar 也叫做 fat-jar 或者 jar-with-dependencies，意思就是包含依赖的 jar。\n  什么是 shade ？\nshade 意为遮挡，在此处可以理解为对依赖的 jar 包的重定向（主要通过重命名的方式）。\n   💁‍♂️ 下文中可能使用 shade 来代替 maven-plugin-shade。\n 基本使用 maven-plugin-shade 必须和 Maven 构建生命周期中的 package 阶段绑定，也就是说，当执行 mvn package 时会自动触发 shade。\n要使用 maven-plugin-shade，只需要在 pom.xml 的  标签下添加它的配置即可，示例如下：\n ...    org.apache.maven.plugins maven-shade-plugin 3.2.4       package  shade       ...  默认情况下会把项目所有的依赖都包含进最终的 jar 包中。当然，我们也可以在  标签内配置更具体的规则。\n常用功能 按需选择要添加到最终 jar 包中依赖 使用  排除不需要的依赖，示例如下：\n   classworlds:classworlds junit:junit jmock:* *:xml-apis org.apache.maven:lib:tests log4j:log4j:jar:    使用  结合  \u0026  标签可实现更灵活的依赖选择，示例如下：\n   junit:junit  junit/framework/** org/junit/**   org/junit/experimental/** org/junit/runners/**    *:*  META-INF/*.SF META-INF/*.DSA META-INF/*.RSA     除了可以通过自定义的 filters 来过滤依赖，此插件还支持自动移除项目中没有使用到的依赖，以此来最小化 jar 包的体积，只需要添加一项配置即可。示例如下：\n true  重定位 class 文件 如果最终的 jar 包被其他的项目所依赖的话，直接地引用此 jar 包中的类可能会导致类加载冲突，这是因为 classpath 中可能存在重复的 class 文件。为了解决这个问题，我们可以使用 shade 提供的重定位功能，把部分类移动到一个全新的包中。示例如下：\n   org.codehaus.plexus.util org.shaded.plexus.util  org.codehaus.plexus.util.xml.Xpp3Dom org.codehaus.plexus.util.xml.pull.*     【涉及标签】\n ：原始包名 ：重命名后的包名 ：原始包内不需要重定位的类，类名支持通配符  例如，在上述示例中，我们把 org.codehaus.plexus.util 包内的所有子包及 class 文件（除了 ~.xml.Xpp3Dom 和 ~.xml.pull 包下的所有 class 文件）重定位到了 org.shaded.plexus.util 包内。\n当然，如果包内的大部分类我们都不需要，一个个排除就显得很繁琐了。此时我们也可以使用  标签来指定我们仅需要的类，示例如下：\n ...  org.codehaus.plexus.util org.shaded.plexus.util  org.codehaud.plexus.util.io.*   ...  生成可执行 jar 包 使用 maven-plugin-shade 后，最终生成的 jar 包可以包含所有项目所需要的依赖。我们会想，能不能直接运行这个 uber-jar 呢？答案是当然可以，并且十分简单，只需要指定  启动类就可以了。示例如下：\n ...    implementation=\"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\" org.sonatype.haven.HavenCli    ...  熟悉 jar 包的朋友们都知道，jar 包中默认会包含一个 MANIFEST.MF 文件，里面描述了一些 jar 包的信息。使用 java 自带的 jar 命令打包的时候可以指定 MANIFEST.MF，其中也可以指定 Main-Class 来使得 jar 包可运行。那么使用 shade 来指定和直接在 MANIFEST.MF 文件中指定有什么区别呢？\n答案是没有区别，细心的读者会发现  标签的父标签是  有一个 implementation 属性，其值为 “~.ManifestResourceTransformer”，意思是 Manifest 资源文件转换器。上述示例只自指定了启动类，因此 shade 会为我们自动生成一个包含 Main-Class 的 MANIFEST.MF 文件，然后在打 jar 包时指定这个文件。\n那如果我们想要完全定制 MANIFEST.MF 文件内容怎么办呢？我们可以使用  标签，示例如下：\n ...    implementation=\"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\"  org.sonatype.haven.ExodusCli 123     ...  生成资源文件 项目中涉及到的依赖可能会有它们所必需的资源文件，使用 shade 可以把它们聚合在同一个 jar 包中。\n默认地，shade 为我们提供了 12 个 ResourceTransformer 类：\n   类名 作用     ApacheLicenseResourceTransformer  防止 LICENSE 文件重复   ApacheNoticeResourceTransformer  准备合并的 NOTICE   AppendingTransformer  为某个资源文件附加内容   ComponentsXmlResourceTransformer  聚合 Plexus components.xml   DontIncludeResourceTransformer  防止包含指定的资源   GroovyResourceTransformer  合并 Apache Groovy 的扩展模块   IncludeResourceTransformer  添加项目中的文件为资源文件   ManifestResourceTransformer  自定义 MANIFEST 文件   PluginXmlResourceTransformer  聚合 Maven 的 plugin.xml 配置   ResourceBundleAppendingTransformer  合并 ResourceBundles   ServicesResourceTransformer  重定位且合并 META-INF/services 资源文件中的 class 文件.   XmlAppendingTransformer  为 XML 资源文件附加内容    每种 ResourceTransformer 的具体使用可以点击对应链接查看官方示例，这里不再赘述。\n如果上述 12 个类都不能够满足我们的需求，我们可以实现 shade 提供的接口，按需自定义一个 ResourceTransformer，实现方法详见官网 Using your own Shader implementation 。\n  转载须知：本文遵循 CC-BY-SA 4.0 许可协议 作者：六开箱 链接：https://lkxed.github.io/posts/maven-plugin-shade/ \\\n ","wordCount":"1650","inLanguage":"zh","datePublished":"2021-03-25T16:43:24+08:00","dateModified":"2021-03-25T16:43:24+08:00","author":{"@type":"Person","name":"六开箱"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lkxed.github.io/posts/maven-plugin-shade/"},"publisher":{"@type":"Organization","name":"六开箱","logo":{"@type":"ImageObject","url":"https://lkxed.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://lkxed.github.io/ accesskey=h title="六开箱 (Alt + H)"><img src=https://lkxed.github.io/favicon.ico alt=logo aria-label=logo height=30>六开箱</a></div><ul id=menu><li><a href=https://lkxed.github.io/posts/ title=文章><span>文章</span></a></li><li><a href=https://lkxed.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://lkxed.github.io/series/ title=系列><span>系列</span></a></li><li><a href=https://lkxed.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://lkxed.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>maven-plugin-shade：介绍与使用</h1><div class=post-meta><span title="2021-03-25 16:43:24 +0800 CST">2021 年 3 月 25 日</span>&nbsp;·&nbsp;1650 字&nbsp;·&nbsp;六开箱&nbsp;｜&nbsp;<a href=https://github.com/lkxed/ rel="noopener noreferrer" target=_blank>关注我🌟</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%bb%8b%e7%bb%8d aria-label=介绍>介绍</a></li><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 aria-label=基本使用>基本使用</a></li><li><a href=#%e5%b8%b8%e7%94%a8%e5%8a%9f%e8%83%bd aria-label=常用功能>常用功能</a><ul><li><a href=#%e6%8c%89%e9%9c%80%e9%80%89%e6%8b%a9%e8%a6%81%e6%b7%bb%e5%8a%a0%e5%88%b0%e6%9c%80%e7%bb%88-jar-%e5%8c%85%e4%b8%ad%e4%be%9d%e8%b5%96 aria-label="按需选择要添加到最终 jar 包中依赖">按需选择要添加到最终 jar 包中依赖</a></li><li><a href=#%e9%87%8d%e5%ae%9a%e4%bd%8d-class-%e6%96%87%e4%bb%b6 aria-label="重定位 class 文件">重定位 class 文件</a></li><li><a href=#%e7%94%9f%e6%88%90%e5%8f%af%e6%89%a7%e8%a1%8c-jar-%e5%8c%85 aria-label="生成可执行 jar 包">生成可执行 jar 包</a></li><li><a href=#%e7%94%9f%e6%88%90%e8%b5%84%e6%ba%90%e6%96%87%e4%bb%b6 aria-label=生成资源文件>生成资源文件</a></li></ul></li></ul></div></details></div><div class=post-content><blockquote><p>使用 maven-plugin-shade 打包你的项目依赖，生成完整的可运行 jar 包。</p></blockquote><h2 id=介绍>介绍<a hidden class=anchor aria-hidden=true href=#介绍>#</a></h2><p>maven-plugin-shade 插件提供了<strong>两个能力</strong>：</p><ol><li>把整个项目（包含它的依赖）都打包到一个 &ldquo;uber-jar&rdquo; 中</li><li>shade - 即重命名某些依赖的包</li></ol><p>由此引出了<strong>两个问题</strong>：</p><ol><li><p>什么是 uber-jar ？</p><p>uber-jar 也叫做 fat-jar 或者 jar-with-dependencies，意思就是包含依赖的 jar。</p></li><li><p>什么是 shade ？</p><p>shade 意为遮挡，在此处可以理解为对依赖的 jar 包的重定向（主要通过重命名的方式）。</p></li></ol><blockquote><p>💁‍♂️ 下文中可能使用 shade 来代替 maven-plugin-shade。</p></blockquote><h2 id=基本使用>基本使用<a hidden class=anchor aria-hidden=true href=#基本使用>#</a></h2><p>maven-plugin-shade 必须和 Maven 构建生命周期中的 package 阶段绑定，也就是说，当执行 <code>mvn package</code> 时会自动触发 shade。</p><p>要使用 maven-plugin-shade，只需要在 pom.xml 的 <code>&lt;plugins></code> 标签下添加它的配置即可，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;project&gt;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    <span class=nt>&lt;build&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;plugins&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;plugin&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;artifactId&gt;</span>maven-shade-plugin<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;version&gt;</span>3.2.4<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=c>&lt;!-- 此处按需编写更具体的配置 --&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;executions&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;execution&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=c>&lt;!-- 和 package 阶段绑定 --&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;phase&gt;</span>package<span class=nt>&lt;/phase&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;goals&gt;</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&lt;goal&gt;</span>shade<span class=nt>&lt;/goal&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;/goals&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;/execution&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/executions&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/plugin&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/plugins&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/build&gt;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=nt>&lt;/project&gt;</span>
</span></span></code></pre></div><p>默认情况下会把项目所有的依赖都包含进最终的 jar 包中。当然，我们也可以在 <code>&lt;configuration></code> 标签内配置更具体的规则。</p><h2 id=常用功能>常用功能<a hidden class=anchor aria-hidden=true href=#常用功能>#</a></h2><h3 id=按需选择要添加到最终-jar-包中依赖>按需选择要添加到最终 jar 包中依赖<a hidden class=anchor aria-hidden=true href=#按需选择要添加到最终-jar-包中依赖>#</a></h3><p>使用 <code>&lt;includes></code> 排除不需要的依赖，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactSet&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;excludes&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;exclude&gt;</span>classworlds:classworlds<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;exclude&gt;</span>junit:junit<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;exclude&gt;</span>jmock:*<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;exclude&gt;</span>*:xml-apis<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;exclude&gt;</span>org.apache.maven:lib:tests<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;exclude&gt;</span>log4j:log4j:jar:<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/excludes&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/artifactSet&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></div><p>使用 <code>&lt;filters></code> 结合 <code>&lt;includes></code> & <code>&lt;excludes></code> 标签可实现更灵活的依赖选择，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;filters&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;filter&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifact&gt;</span>junit:junit<span class=nt>&lt;/artifact&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;includes&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;include&gt;</span>junit/framework/**<span class=nt>&lt;/include&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;include&gt;</span>org/junit/**<span class=nt>&lt;/include&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/includes&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;excludes&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;exclude&gt;</span>org/junit/experimental/**<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;exclude&gt;</span>org/junit/runners/**<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/excludes&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/filter&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;filter&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifact&gt;</span>*:*<span class=nt>&lt;/artifact&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;excludes&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;exclude&gt;</span>META-INF/*.SF<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;exclude&gt;</span>META-INF/*.DSA<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;exclude&gt;</span>META-INF/*.RSA<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/excludes&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/filter&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/filters&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></div><p>除了可以通过自定义的 filters 来过滤依赖，此插件还支持自动移除项目中没有使用到的依赖，以此来最小化 jar 包的体积，只需要添加一项配置即可。示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;minimizeJar&gt;</span>true<span class=nt>&lt;/minimizeJar&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></div><h3 id=重定位-class-文件>重定位 class 文件<a hidden class=anchor aria-hidden=true href=#重定位-class-文件>#</a></h3><p>如果最终的 jar 包被其他的项目所依赖的话，直接地引用此 jar 包中的类可能会导致类加载冲突，这是因为 classpath 中可能存在重复的 class 文件。为了解决这个问题，我们可以使用 shade 提供的重定位功能，把部分类移动到一个全新的包中。示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;relocations&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;relocation&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;pattern&gt;</span>org.codehaus.plexus.util<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;shadedPattern&gt;</span>org.shaded.plexus.util<span class=nt>&lt;/shadedPattern&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;excludes&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;exclude&gt;</span>org.codehaus.plexus.util.xml.Xpp3Dom<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;exclude&gt;</span>org.codehaus.plexus.util.xml.pull.*<span class=nt>&lt;/exclude&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/excludes&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/relocation&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/relocations&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></div><p>【涉及标签】</p><ul><li><code>&lt;pattern></code>：原始包名</li><li><code>&lt;shadedPattern></code>：重命名后的包名</li><li><code>&lt;excludes></code>：原始包内不需要重定位的类，类名支持通配符</li></ul><p>例如，在上述示例中，我们把 org.codehaus.plexus.util 包内的所有子包及 class 文件（除了 ~.xml.Xpp3Dom 和 ~.xml.pull 包下的所有 class 文件）重定位到了 org.shaded.plexus.util 包内。</p><p>当然，如果包内的大部分类我们都不需要，一个个排除就显得很繁琐了。此时我们也可以使用 <code>&lt;includes></code> 标签来指定我们仅需要的类，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;project&gt;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    <span class=nt>&lt;relocation&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;pattern&gt;</span>org.codehaus.plexus.util<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;shadedPattern&gt;</span>org.shaded.plexus.util<span class=nt>&lt;/shadedPattern&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;includes&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;include&gt;</span>org.codehaud.plexus.util.io.*<span class=nt>&lt;/include&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/includes&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/relocation&gt;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=nt>&lt;/project&gt;</span>
</span></span></code></pre></div><h3 id=生成可执行-jar-包>生成可执行 jar 包<a hidden class=anchor aria-hidden=true href=#生成可执行-jar-包>#</a></h3><p>使用 maven-plugin-shade 后，最终生成的 jar 包可以包含所有项目所需要的依赖。我们会想，能不能直接运行这个 uber-jar 呢？答案是当然可以，并且十分简单，只需要指定 <code>&lt;mainClass></code> 启动类就可以了。示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;project&gt;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;transformers&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;transformer</span> <span class=na>implementation=</span><span class=s>&#34;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;mainClass&gt;</span>org.sonatype.haven.HavenCli<span class=nt>&lt;/mainClass&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/transformer&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/transformers&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=nt>&lt;/project&gt;</span>
</span></span></code></pre></div><p>熟悉 jar 包的朋友们都知道，jar 包中默认会包含一个 MANIFEST.MF 文件，里面描述了一些 jar 包的信息。使用 java 自带的 jar 命令打包的时候可以指定 MANIFEST.MF，其中也可以指定 Main-Class 来使得 jar 包可运行。那么使用 shade 来指定和直接在 MANIFEST.MF 文件中指定有什么区别呢？</p><p>答案是没有区别，细心的读者会发现 <code>&lt;mainClass></code> 标签的父标签是 <code>&lt;transformer></code> 有一个 implementation 属性，其值为 &ldquo;~.ManifestResourceTransformer&rdquo;，意思是 Manifest 资源文件转换器。上述示例只自指定了启动类，因此 shade 会为我们自动生成一个包含 Main-Class 的 MANIFEST.MF 文件，然后在打 jar 包时指定这个文件。</p><p>那如果我们想要完全定制 MANIFEST.MF 文件内容怎么办呢？我们可以使用 <code>&lt;manifestEntries></code> 标签，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;project&gt;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;transformers&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;transformer</span> <span class=na>implementation=</span><span class=s>&#34;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;manifestEntries&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;Main-Class&gt;</span>org.sonatype.haven.ExodusCli<span class=nt>&lt;/Main-Class&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;Build-Number&gt;</span>123<span class=nt>&lt;/Build-Number&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/manifestEntries&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/transformer&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/transformers&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=nt>&lt;/project&gt;</span>
</span></span></code></pre></div><h3 id=生成资源文件>生成资源文件<a hidden class=anchor aria-hidden=true href=#生成资源文件>#</a></h3><p>项目中涉及到的依赖可能会有它们所必需的资源文件，使用 shade 可以把它们聚合在同一个 jar 包中。</p><p>默认地，shade 为我们提供了 12 个 ResourceTransformer 类：</p><table><thead><tr><th>类名</th><th>作用</th></tr></thead><tbody><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#ApacheLicenseResourceTransformer target=_blank rel="noopener noreferrer">ApacheLicenseResourceTransformer</a></td><td>防止 LICENSE 文件重复</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#ApacheNoticeResourceTransformer target=_blank rel="noopener noreferrer">ApacheNoticeResourceTransformer</a></td><td>准备合并的 NOTICE</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#AppendingTransformer target=_blank rel="noopener noreferrer">AppendingTransformer</a></td><td>为某个资源文件附加内容</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#ComponentsXmlResourceTransformer target=_blank rel="noopener noreferrer">ComponentsXmlResourceTransformer</a></td><td>聚合 Plexus <code>components.xml</code></td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#DontIncludeResourceTransformer target=_blank rel="noopener noreferrer">DontIncludeResourceTransformer</a></td><td>防止包含指定的资源</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#GroovyResourceTransformer target=_blank rel="noopener noreferrer">GroovyResourceTransformer</a></td><td>合并 Apache Groovy 的扩展模块</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#IncludeResourceTransformer target=_blank rel="noopener noreferrer">IncludeResourceTransformer</a></td><td>添加项目中的文件为资源文件</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#ManifestResourceTransformer target=_blank rel="noopener noreferrer">ManifestResourceTransformer</a></td><td>自定义 MANIFEST 文件</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#PluginXmlResourceTransformer target=_blank rel="noopener noreferrer">PluginXmlResourceTransformer</a></td><td>聚合 Maven 的 plugin.xml 配置</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#ResourceBundleAppendingTransformer target=_blank rel="noopener noreferrer">ResourceBundleAppendingTransformer</a></td><td>合并 ResourceBundles</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#ServicesResourceTransformer target=_blank rel="noopener noreferrer">ServicesResourceTransformer</a></td><td>重定位且合并 META-INF/services 资源文件中的 class 文件.</td></tr><tr><td><a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#XmlAppendingTransformer target=_blank rel="noopener noreferrer">XmlAppendingTransformer</a></td><td>为 XML 资源文件附加内容</td></tr></tbody></table><p>每种 ResourceTransformer 的具体使用可以点击对应链接查看官方示例，这里不再赘述。</p><p>如果上述 12 个类都不能够满足我们的需求，我们可以实现 shade 提供的接口，按需自定义一个 ResourceTransformer，实现方法详见官网 <a href=http://maven.apache.org/plugins/maven-shade-plugin/examples/use-shader-other-impl.html target=_blank rel="noopener noreferrer">Using your own Shader implementation</a>
。</p><hr><blockquote><p>转载须知：本文遵循 <a href=https://creativecommons.org/licenses/by-sa/4.0/deed.zh target=_blank rel="noopener noreferrer">CC-BY-SA 4.0 许可协议</a><br>作者：<a href=https://github.com/lkxed/ target=_blank rel="noopener noreferrer">六开箱</a><br>链接：<a href=https://lkxed.github.io/posts/maven-plugin-shade/ target=_blank rel="noopener noreferrer">https://lkxed.github.io/posts/maven-plugin-shade/</a>
\</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://lkxed.github.io/tags/java/>Java</a></li><li><a href=https://lkxed.github.io/tags/maven/>Maven</a></li><li><a href=https://lkxed.github.io/tags/%E6%8F%92%E4%BB%B6/>插件</a></li><li><a href=https://lkxed.github.io/tags/%E4%BB%8B%E7%BB%8D/>介绍</a></li><li><a href=https://lkxed.github.io/tags/%E4%BD%BF%E7%94%A8/>使用</a></li><li><a href=https://lkxed.github.io/tags/%E6%95%99%E7%A8%8B/>教程</a></li></ul><nav class=paginav><a class=prev href=https://lkxed.github.io/posts/kafka-perf-test-scripts/><span class=title>« 上一页</span><br><span>Kafka 性能测试脚本：介绍与使用</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=lkxed/lkxed.github.io data-repo-id=R_kgDOHF00eA data-category=Announcements data-category-id=DIC_kwDOHF00eM4COXzh data-mapping=og:title data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><div class=social-icons><a href=https://github.com/lkxed/ target=_blank rel="noopener noreferrer me" title=GitHub><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://space.bilibili.com/88033726/ target=_blank rel="noopener noreferrer me" title=Bilibili><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" xmlns="http://www.w3.org/2000/svg"><rect x="1.3333" y="6" width="21.333" height="15.333" rx="4" ry="4"/><path d="m8 12.4v1.2"/><path d="m16 12.4v1.2"/><path d="m5.8853 2.6667L8.552 5.3334"/><path d="m18.115 2.6667-2.6667 2.6667"/></svg></a></div><span>&copy; 2022 <a href=https://lkxed.github.io/>六开箱</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/lkxed/hugo-PaperMod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="复制";function s(){e.innerText="已复制！",setTimeout(()=>{e.innerText="复制"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>